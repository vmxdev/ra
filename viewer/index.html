<html lang="en">
<head>
 <meta charset="utf-8">
 <title>RA - simple Solar System simulator</title>
 <link rel="stylesheet" href="jquery-ui/jquery-ui.theme.min.css">
 <link rel="stylesheet" href="jquery-ui/jquery-ui.structure.min.css">
 <style>
  #planets-canvas {
	padding: 2%;
	width: 96%;
	height: 70%;
  }
  #timeline {
	margin-bottom: 10px;
  }
  #speed-parent {
	padding: 10px;
	margin: 10px;
  }
  #speed-parent span {}
  #speed {
	float: right;
	width: 80%;
  }
 </style>
 <script src="jquery-ui/external/jquery/jquery.js"></script>
 <script src="jquery-ui/jquery-ui.min.js"></script>
 <script src="threejs/three.min.js"></script>
 <script src="threejs/OrbitControls.js"></script>
 <script>
	var camera, scene, renderer, controls;
	var planets, mesh;
	var simtime = 0;
	var speed = 10;
	var nrecords;
	var SCALE = 1000000000;
	var DELAY = 100;

	function init(w, h, dataplanets) {
		scene = new THREE.Scene();

		camera = new THREE.PerspectiveCamera(70, w / h, 1, 1000);
		camera.position.z = 300;

		renderer = new THREE.WebGLRenderer({ antialias: true });

		/* camera movement */
		controls = new THREE.OrbitControls(camera, renderer.domElement);
		controls.addEventListener('change', render);

		planets = new Array();
		mesh = new THREE.Group();
		for (i=0; i<dataplanets.length; i++) {
			var geometry, material, planet;

			geometry = new THREE.SphereBufferGeometry(1, 8, 8);
			material = new THREE.MeshNormalMaterial();
			planet = new THREE.Mesh(geometry, material);
			planet.position.x = dataplanets[i].x / SCALE;
			planet.position.y = dataplanets[i].y / SCALE;
			planet.position.z = dataplanets[i].z / SCALE;
			planets.push(planet);
			mesh.add(planet);
		}
		scene.add(mesh);

		renderer.setSize(w, h);
		$("#planets-canvas").append(renderer.domElement);
	}

	function animate() {
		requestAnimationFrame(animate);
		controls.update();
		renderer.render(scene, camera);
	}

	function render() {
		renderer.render(scene, camera);
	}

	function update() {
		simtime++;
		if (simtime >= nrecords) {
			simtime = 0;
		}
		$.getJSON("planets.php", { time: simtime } )
			.done(function( data ) {
				$("#timeline").slider('value', simtime);
				for (i=0; i<planets.length; i++) {
					planets[i].position.x = data.planets[i].x / SCALE;
					planets[i].position.y = data.planets[i].y / SCALE;
					planets[i].position.z = data.planets[i].z / SCALE;
				}
		});
		setTimeout(update, DELAY);
	}

	$(function() {
		/* fetch data with time == 0 to get number of records in data file */
		$.getJSON("planets.php", { time: "0" } )
			.done(function( data ) {
				$("#timeline").slider({
					min: 0,
					max: data.nrecords
				});

				$("#speed").slider({
					min: 0,
					max: 100
				});
				nrecords = data.nrecords;
				w = $("#planets-canvas").width();
				h = $("#planets-canvas").height();
				init(w, h, data.planets);
				animate();
				setTimeout(update, DELAY);
		});
		$("#timeline").on("slidechange", function(event, ui) {
			simtime = $(this).slider('value');
		});
		$("#speed").on("slidechange", function(event, ui) {
		});
	});
	</script>
</head>

<body>
 <div id="planets-canvas"></div>
 <div id="timeline"></div>
 <div if="speed-parent" style="width: 300px;">
  <span>Speed: </span>
  <div id="speed"></div>
 </div>
</body>
</html>
